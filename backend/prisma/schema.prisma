generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  
  // Billing
  stripeCustomerId String?
  subscriptionStatus String @default("active") // active, trialing, past_due, canceled, unpaid
  plan              String @default("FREE")    // FREE, PRO
  currentPeriodEnd  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
  leads     Lead[]
  campaigns Campaign[]
  mailboxes Mailbox[]
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  name        String?
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Lead {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String?
  lastName  String?
  company   String?
  jobTitle  String?
  website   String?
  location  String?
  timezone  String? 
  metadata  String?
  status    String   @default("NEW")
  classification String? // POSITIVE, NEGATIVE, OOO, OBJECTION, INFO
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  campaignLeads CampaignLead[]
  events        Event[]
  emailMessages EmailMessage[]
}

model Campaign {
  id        String   @id @default(uuid())
  name      String
  status    String   @default("DRAFT")
  dailyLimit Int?     
  startTime  String?  
  endTime    String?  
  timezone   String?  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  sequences Sequence[]
  leads     CampaignLead[]
  events    Event[]
  mailboxId String?
  mailbox   Mailbox? @relation(fields: [mailboxId], references: [id])
}

model Sequence {
  id         String   @id @default(uuid())
  campaignId String
  title      String?
  order      Int      
  type       String   
  subject    String?
  body       String?  
  delayDays  Int      @default(0)
  delayHours Int      @default(0)
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  condition  String   @default("ALWAYS") // ALWAYS, IF_NO_OPEN, IF_NO_REPLY, IF_CLICKED
  @@index([campaignId])
}

model CampaignLead {
  id         String   @id @default(uuid())
  campaignId String
  leadId     String
  status     String   @default("NEW")
  failureReason String?
  currentStep  Int      @default(0) 
  nextActionAt DateTime?            
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead       Lead     @relation(fields: [leadId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  @@unique([campaignId, leadId])
  @@index([nextActionAt]) 
}

model Mailbox {
  id          String   @id @default(uuid())
  email       String   @unique
  name        String?  // Internal name
  fromName    String?  // Display name in emails
  status      String   @default("DISCONNECTED") // CONNECTED, ERROR
  smtpHost    String
  smtpPort    Int
  smtpUser    String
  smtpPass    String
  imapHost    String?
  imapPort    Int?
  imapUser    String?
  imapPass    String?
  dailyLimit  Int      @default(50)
  sentCount   Int      @default(0) 
  lastReset   DateTime @default(now())
  
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  warmupEnabled   Boolean   @default(false)
  warmupStartedAt DateTime?
  
  campaigns   Campaign[]
  emailMessages EmailMessage[]
}

model Event {
  id         String    @id @default(uuid())
  type       String
  campaignId String?
  leadId     String?
  sequenceId String?
  metadata   String?     
  createdAt  DateTime  @default(now())
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead       Lead?     @relation(fields: [leadId], references: [id])
  @@index([campaignId])
}

model EmailMessage {
  id        String   @id @default(uuid())
  mailboxId String
  leadId    String?
  remoteId  String   // IMAP UID
  subject   String?
  snippet   String?
  body      String?  
  htmlBody  String?
  fromEmail String
  toEmail   String
  receivedAt DateTime
  isRead    Boolean  @default(false)
  folder    String   @default("INBOX")
  createdAt DateTime @default(now())

  mailbox   Mailbox @relation(fields: [mailboxId], references: [id])
  lead      Lead?   @relation(fields: [leadId], references: [id])
  
  @@unique([mailboxId, remoteId])
  @@index([mailboxId])
  @@index([leadId])
}
